<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Тест (Линейный): Расхождения при приеме товара (1С)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; line-height: 1.35; }
    .card { max-width: 980px; margin: 0 auto; border: 1px solid #ddd; border-radius: 12px; padding: 18px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .meta { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 12px 0 18px; }
    input, select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; }
    .q { padding: 14px 0; border-top: 1px solid #eee; }
    .q:first-of-type { border-top: none; }
    .q-title { font-weight: 700; margin: 0 0 10px; }
    .opt { display: block; padding: 8px 10px; border: 1px solid #eee; border-radius: 10px; margin: 8px 0; cursor: pointer; }
    .opt:hover { background: #fafafa; }
    .actions { display:flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; background: white; cursor: pointer; }
    button.primary { background: #111; color: #fff; border-color: #111; }
    .status { margin-top: 12px; font-size: 14px; }
    .muted { color:#666; }
    .hidden { display:none; }
    .result { padding: 12px; border-radius: 12px; background:#f7f7f7; margin-top: 14px; }
    .badge { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#eee; font-size: 12px; margin-left: 8px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Тест (Линейный) <span class="badge">25 вопросов</span></h1>
    <div class="muted">Ответьте на все вопросы и нажмите «Отправить результат». Итоги сохраняются в таблицу.</div>

    <div class="meta">
      <div>
        <label>ФИО</label>
        <input id="name" placeholder="Например: Иванов Иван" />
      </div>
      <div>
        <label>Роль</label>
        <select id="role">
          <option value="">Выберите…</option>
          <option>Линейный сотрудник</option>
        </select>
      </div>
    </div>

    <div id="quiz"></div>

    <div class="actions">
      <button id="btnCheck">Проверить (локально)</button>
      <button class="primary" id="btnSubmit">Отправить результат</button>
      <button id="btnReset">Сбросить</button>
    </div>

    <div class="status" id="status"></div>
    <div class="result hidden" id="resultBox"></div>
  </div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbziYMZkxWnhZiAiHkPr4-TidgzpyR0y5V9ToVXus-CnQfSD_qKGXWCHGDHRK55Fyl-W/exec";
  const TEST_TYPE = "LINEAR";

  const QUESTIONS = [
    { id: 1, text: "Где в 1С находится «Обработка расхождений при приеме товара»?",
      options: [
        "Склад и логистика → Листы разногласий → Обработка расхождений при приеме товара",
        "Продажи → Возвраты → Обработка расхождений",
        "Финансы → Инвентаризация → Расхождения",
        "Закупки → Поставщики → Разногласия"
      ], correct: 0
    },
    { id: 2, text: "Что делает эта обработка?",
      options: [
        "Показывает Листы разногласий и товары для обработки (подтвердить/сторнировать)",
        "Меняет цены на товары",
        "Создает заявки на закупку",
        "Открывает кассовую смену"
      ], correct: 0
    },
    { id: 3, text: "Что сделать перед «Сформировать»?",
      options: [
        "Проверить «Отправитель», заполнить «Получатели», нажать «Сформировать»",
        "Создать продажу и провести",
        "Удалить лист разногласий",
        "Сменить пользователя 1С"
      ], correct: 0
    },
    { id: 4, text: "Что подставляется в «Отправитель» автоматически?",
      options: [
        "Филиал, к которому приписан сотрудник",
        "Склад поставщика",
        "Любой филиал с остатком",
        "Последний выбранный получатель"
      ], correct: 0
    },
    { id: 5, text: "Зачем заполняют «Получатели»?",
      options: [
        "Чтобы отобрать нужные документы/филиалы и загрузить их в таблицу",
        "Чтобы распечатать чеки",
        "Чтобы начислить премию",
        "Чтобы закрыть кассу"
      ], correct: 0
    },
    { id: 6, text: "Что делает «Группировать по изделиям»?",
      options: [
        "Сортирует документы в таблице по категории товара",
        "Группирует по кассирам",
        "Группирует по поставщикам",
        "Группирует по скидкам"
      ], correct: 0
    },
    { id: 7, text: "Из каких частей состоит интерфейс?",
      options: [
        "Кнопки управления, отборы, табличная часть",
        "Только табличная часть",
        "Касса, чеки, возвраты",
        "Только печать"
      ], correct: 0
    },
    { id: 8, text: "Какие два уровня у таблицы?",
      options: [
        "Документы (Листы разногласий) и товары внутри выбранного документа",
        "Магазины и сотрудники",
        "Поставщики и договоры",
        "Чеки и товары"
      ], correct: 0
    },
    { id: 9, text: "Красное значение с минусом в «Заявлено» — это…",
      options: [
        "Недоезд (не дождались товара)",
        "Лишний товар",
        "Товар списан",
        "Товар зарезервирован"
      ], correct: 0
    },
    { id: 10, text: "Синее значение в «Заявлено» — это…",
      options: [
        "Лишний товар (переизбыток)",
        "Недоезд",
        "Уценка",
        "Брак"
      ], correct: 0
    },
    { id: 11, text: "Откуда берется «Комментарий заявителя»?",
      options: [
        "Из листа разногласий: поле «Комментарий» и строки табличной части",
        "Из карточки товара",
        "Из настроек пользователя",
        "Из почты"
      ], correct: 0
    },
    { id: 12, text: "Что указывается в «Подтверждено»?",
      options: [
        "Количество, которое подтверждаем при обработке",
        "Количество в прайсе",
        "Количество на витрине",
        "Количество в заказе клиента"
      ], correct: 0
    },
    { id: 13, text: "Как выбрать «Причину»?",
      options: [
        "Двойной клик по ячейке → выбор из списка",
        "Только администратор 1С",
        "Она всегда заполняется сама",
        "Нужно написать письмо"
      ], correct: 0
    },
    { id: 14, text: "Зачем нужен «Подтверждающий документ»?",
      options: [
        "Чтобы связать лист разногласий с документом, который его закрывает",
        "Чтобы прикрепить фото",
        "Чтобы изменить цену",
        "Чтобы выдать доступ"
      ], correct: 0
    },
    { id: 15, text: "Что писать в «Комментарий подтверждающего»?",
      options: [
        "Короткое пояснение по ситуации/действиям",
        "Только номер телефона",
        "Только дату",
        "Ничего — поле не используется"
      ], correct: 0
    },
    { id: 16, text: "Что показывает «Остаток»?",
      options: [
        "Учетный остаток товара у отправителя",
        "Остаток денег в кассе",
        "Остаток времени смены",
        "Остаток лимита закупок"
      ], correct: 0
    },
    { id: 17, text: "Как увидеть незакрытые расхождения по отправителю?",
      options: [
        "Отправитель/Получатели → «Сформировать»",
        "«Продажи за день»",
        "«Печать ценников»",
        "«Загрузка прайса»"
      ], correct: 0
    },
    { id: 18, text: "Что обязательно указать для подтверждения?",
      options: [
        "«Подтверждено» и «Причина»",
        "Только «Остаток»",
        "Только комментарий",
        "Только ФИО"
      ], correct: 0
    },
    { id: 19, text: "Когда выбирают «Выгружен на другом филиале»?",
      options: [
        "Когда товар должен был прийти в один филиал, но выгрузили в другой",
        "Когда клиент не пришел за заказом",
        "Когда цена не совпала",
        "Когда касса зависла"
      ], correct: 0
    },
    { id: 20, text: "Что сделать при «Выгружен на другом филиале»?",
      options: [
        "Указать «Подтверждено» и выбрать «Подтверждающий документ» (связанное разногласие)",
        "Только поставить галочку",
        "Списать товар",
        "Сделать уценку"
      ], correct: 0
    },
    { id: 21, text: "Почему система может не дать подтвердить «Выгружен на другом филиале»?",
      options: [
        "Не выбраны все подтверждающие документы и/или количества не сходятся",
        "Не заполнен номер телефона",
        "Товар дорогой",
        "Приемка была ночью"
      ], correct: 0
    },
    { id: 22, text: "Как завершить подтверждение?",
      options: [
        "Отметить галочкой и нажать «Подтвердить отмеченные»",
        "Закрыть окно — само сохранится",
        "Перезайти в 1С",
        "Создать продажу"
      ], correct: 0
    },
    { id: 23, text: "Для каких причин обычно НЕ нужен подтверждающий документ?",
      options: [
        "Микс, Не погружен на отправителе, Вернулся отправителю, Лишний товар",
        "Только для «Выгружен на другом филиале»",
        "Всегда нужен",
        "Только для «Недоезд»"
      ], correct: 0
    },
    { id: 24, text: "Что создается автоматически при причинах «Микс/Не погружен/Вернулся/Лишний»?",
      options: [
        "Документ «Инвентаризация» (и закрывающее подтверждение)",
        "Заявка на закупку",
        "Маркетинговая акция",
        "Акт уценки"
      ], correct: 0
    },
    { id: 25, text: "Что такое «Сторнирование»?",
      options: [
        "Если расхождения фактически нет и лист создан ошибочно — оформляют сторнирование (делает инициатор)",
        "Перемещение товара между складами",
        "Уценка товара",
        "Резервирование товара"
      ], correct: 0
    }
  ];

  let startedAt = Date.now();

  function render() {
    const root = document.getElementById('quiz');
    root.innerHTML = QUESTIONS.map((q, idx) => `
      <div class="q" data-qid="${q.id}">
        <div class="q-title">${idx+1}. ${q.text}</div>
        ${q.options.map((opt, oi) => `
          <label class="opt">
            <input type="radio" name="q_${q.id}" value="${oi}" />
            ${opt}
          </label>
        `).join('')}
      </div>
    `).join('');
  }

  function getAnswers() {
    const answers = {};
    for (const q of QUESTIONS) {
      const sel = document.querySelector(\`input[name="q_\${q.id}"]:checked\`);
      answers[q.id] = sel ? Number(sel.value) : null;
    }
    return answers;
  }

  function grade(answers) {
    let score = 0;
    for (const q of QUESTIONS) if (answers[q.id] === q.correct) score++;
    return score;
  }

  function validateMeta() {
    const name = document.getElementById('name').value.trim();
    const role = document.getElementById('role').value.trim();
    if (!name) return { ok:false, msg: "Заполни ФИО." };
    if (!role) return { ok:false, msg: "Выбери роль." };
    return { ok:true, name, role };
  }

  function unansweredCount(answers) {
    return Object.values(answers).filter(v => v === null).length;
  }

  function setStatus(msg, isError=false) {
    const el = document.getElementById('status');
    el.textContent = msg;
    el.style.color = isError ? "#b00020" : "#111";
  }

  function showResult(score, total, durationSec, saved=false) {
    const box = document.getElementById('resultBox');
    const percent = Math.round((score/total)*100);
    const pass = percent >= 80; // порог можно поменять
    box.classList.remove('hidden');
    box.innerHTML = `
      <div><b>Результат:</b> ${score} / ${total} (${percent}%)</div>
      <div><b>Статус:</b> ${pass ? "СДАН" : "НЕ СДАН"}</div>
      <div class="muted">Время: ${durationSec} сек. ${saved ? "(сохранено)" : ""}</div>
    `;
  }

  async function submit() {
    const meta = validateMeta();
    if (!meta.ok) return setStatus(meta.msg, true);

    const answers = getAnswers();
    const miss = unansweredCount(answers);
    if (miss > 0) return setStatus(\`Нужно ответить на все вопросы. Не отвечено: \${miss}\`, true);

    const score = grade(answers);
    const total = QUESTIONS.length;
    const durationSec = Math.round((Date.now() - startedAt) / 1000);

    if (!SCRIPT_URL || SCRIPT_URL.includes("PASTE_YOUR")) {
      return setStatus("Не задан SCRIPT_URL. Вставь URL веб-приложения Apps Script.", true);
    }

    const payload = {
      testType: TEST_TYPE,
      name: meta.name,
      role: meta.role,
      score,
      total,
      durationSec,
      userAgent: navigator.userAgent,
      answers
    };

    setStatus("Отправляю результат…");
    const resp = await fetch(SCRIPT_URL, {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });

    const text = await resp.text();
    let json;
    try { json = JSON.parse(text); } catch { json = { ok:false, error:text }; }

    if (json.ok) {
      showResult(score, total, durationSec, true);
      setStatus("Готово! Результат сохранён.", false);
    } else {
      setStatus("Ошибка сохранения: " + (json.error || "unknown"), true);
    }
  }

  function resetAll() {
    document.querySelectorAll('input[type="radio"]').forEach(i => i.checked = false);
    document.getElementById('resultBox').classList.add('hidden');
    setStatus("Сброшено.");
    startedAt = Date.now();
  }

  document.getElementById('btnCheck').addEventListener('click', () => {
    const meta = validateMeta();
    if (!meta.ok) return setStatus(meta.msg, true);

    const answers = getAnswers();
    const miss = unansweredCount(answers);
    if (miss > 0) return setStatus(`Нужно ответить на все вопросы. Не отвечено: ${miss}`, true);

    const score = grade(answers);
    const durationSec = Math.round((Date.now() - startedAt) / 1000);
    showResult(score, QUESTIONS.length, durationSec, false);
    setStatus("Проверено локально (без сохранения).");
  });

  document.getElementById('btnSubmit').addEventListener('click', submit);
  document.getElementById('btnReset').addEventListener('click', resetAll);

  render();
</script>
</body>
</html>
